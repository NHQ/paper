<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<title>HSLColor</title>
	<script type="text/javascript" src="../javascripts/paper.js"></script>
	<script type="text/javascript" src="../javascripts/underscore-min.js"></script>
	<script type="text/javascript" src="../javascripts/store.js"></script>
	<script type="text/javascript">
paper.install(window);
window.onload = function(){
colz = store.get('colors');
sinceLast = new Date().getTime(); 
paper.setup('canvas');
center = view.center;

// notes: smudge draw. user holds down to "soak" up color alpha, and then as they drag, the alpha decerases until gone. 
  

  gg = {
    init: function(){
      _.bindAll(this);
      this.groupAll = new Group();
      this.globs = Object.create(null);
			this.tool = new Tool();
			this.tool.onMouseDrag = this.mouseDrag();
		  this.tool.onMouseDown = this.mouseDown();
			this.tool.onMouseUp = this.mouseUp();
			this.tool.activate();
			//this.spirals(view.center)
			this.draw()
			//this.spiral.go.apply(this, [view.center]);
			view.draw()
    },
    globs:{},
    target: {
      item: null,
      setItem: function(item, bool){
        var i = this.target.item || null;
        if(i){
          if(item._id != i._id)
          i.selected = false;
        //  gg.globs.selectRect.remove();
        //  gg.globs.selectDot.remove();
          view.draw();
        }
        item.fullySelected = bool;
        this.target.item = item;
/*      
        this.globs.selectRect = new Path.Rectangle(item.bounds)
        this.globs.selectRect.insertBelow(item);
        this.globs.selectRect.selectable = false;
        this.globs.selectRect.style = {
        strokeColor : new HSBColor(210,1,1,.2)       
        };
        this.globs.selectDot = new Path.Circle(item.position, 3);
        this.globs.selectDot.insertBelow(item);
        this.globs.selectDot.style = {
          fillColor: '#000',
          strokeWidth: 0
        }
*/ 
      },
      setSegment: function(item){
        this.target.segment = item;
      }
    },
    events: {
      select: function(event){
          var hit = project.hitTest(event.point, {tolerance: 10, fill: true, stroke:true, segments: true})
          if (hit && hit.item.selectable){
            /* clear all selected
            _.each(project.layers, function(lay){
              _.each(lay.children, function(chi){
                chi.selected = false;
              })
            })
            this.funs.deSelect.apply(this);
            *///select new
            //if(this.target.item && this.target.item._id != hit.item._id){console.log('hair');this.target.item.selected = false}
            this.target.setItem.apply(this, [hit.item, true]);
            //this.funs.select.apply(this, [hit.item, true])
            this.tool.onMouseDown = this.mouseDown(this.events.grabSegment, this.events.select);
            //this.tool.onMouseUp = this.mouseUp(this.events.grabSegment, this.events.select);
            // need to function this mouseDown to target item's parts for drag, while also keep item selection on ...
            //hit.segment.point = new Point([0,0])
          }
          else {
            console.log('miss')
            _.each(project.layers, function(lay){
              _.each(lay.children, function(chi){
                chi.selected = false;
              })
            })
            //this.funs.deSelect.apply(this);
            this.tool.onMouseDown = this.mouseDown(this.events.select);
            this.tool.onMouseDrag = this.mouseDown();
          }
        },
        grabSegment: function(event){
          var hit = project.hitTest(event.point, {tolerance: 30, segments: true})
          if(hit && hit.segment && hit.item.selectable){
            this.target.setSegment.apply(this, [hit.segment]);
            this.tool.onMouseDrag = this.mouseDrag(this.events.dragSegment)
            this.tool.onMouseUp = this.mouseUp(this.events.dropSegment)
          }
          else this.tool.onMouseDrag = this.mouseDrag();
        },
        dragSegment: function(event){
          this.target.segment.point = event.point;
        //  this.target.item.smooth();
        //  this.tool.onMouseDown = this.mouseDown(this.events.grabSegment, this.events.select);
        },
        dropSegment: function(event){
          this.tool.onMouseDrag = this.mouseDrag();
          this.tool.onMouseDown = this.mouseDown(this.events.grabSegment, this.events.select);
        },
        selected: function(event){
          var hit = project.hitTest(event.point, {tolerance: 50, segments: true})
          if(hit && hit.segment){
            hit.segment.point = event.point
          }
        },
        draw: function(event){
          console.log(this)
          this.layer = new Layer();
          this.path = new Path();
          this.path.add(event.point)
          this.target.setItem.call(this, this.path, false);
          //this.path.fillColor = colorPicker.pal;
          this.path.strokeWidth = 2;
          this.path.strokeCap = 'round';
          this.path.dashArray = [10,10];
        },
        drawDrag: function(event){
          console.log(this)
          this.path.add(event.point);
          var gradient = new Gradient([['black',],['orange',.33],[ new HSBColor(210,1,1,.2),.56],['orange',.99]], 'radial');
          var gcolor = new GradientColor(gradient, this.path.center || [this.path.position.x, this.path.position.y], this.path.position.add(this.path.bounds.width/3));
          this.path.strokeColor = gcolor;
        }
    },
    funs: {
      select: function(item, fully){
        if(_.contains(this.globs, item)){return}
        this.globs.selectRect = new Path.Rectangle(item.bounds);
        // this.globs.selectRect.selectable = false;
        this.globs.selectRect.style = {
          strokeColor : new HSBColor(210,1,1,.2)
        };
        this.globs.selectDot = new Path.Circle(item.position, 3);
        this.globs.selectDot.style = {
          fillColor: '#000',
          strokeWidth: 0
        };
        item.selected = fully;

      },
      deSelect: function(item){
        this.globs.selectRect.remove();
        this.globs.selectDot.remove();
        view.draw();
        //item.selected = false
      },
      dot: function(){
        console.log(arguments)
        for (i in arguments){
          var dot = new Path.Circle(arguments[i], 3);
          dot.style = {
            fillColor: '#000',
            strokeWidth: 0
          } 
        }
      }
    },
    remove:function(){
      this.layer.remove();
    },
    mouseDown:function(){
      var guments = arguments;
      return function(event){        
        for (var i = 0; i<guments.length;++i){
          guments[i].call(gg, event) 
        }
      }
    },
    mouseUp:function(event){
      var guments = arguments;
      return function(event){  
        for (var i = 0; i<guments.length;++i){
          guments[i].call(gg, event) 
        }
      }
    },
    mouseDrag:function(event){
      var guments = arguments;
      return function(event){  
        for (var i = 0; i<guments.length;++i){
          guments[i].call(gg, event) 
        }
      }
    },
    draw: function(){
      this.tool.onMouseDown = this.mouseDown.call(this, this.events.draw);
//      this.tool.onMouseDowm = this.mouseDown.call(this, this.events.draw)
      this.tool.onMouseDrag = this.mouseDrag.call(this, this.events.drawDrag)
    },
    spiral: {
    go: function(e){
      console.log(this.spiral.mx)
      //_.bindAll(this);
      e.preventDefault;
      this.spiral.stopper = 1;
        
        
        function end (){
          var gradient = new Gradient([['black',],['orange',.33],[ new HSBColor(210,1,1,.2),.56],['orange',.99]], 'radial');
          var gcolor = new GradientColor(gradient, this.target.center || [this.target.item.position.x, this.target.item.position.y], this.target.item.position.add(this.target.item.bounds.width/3))
          this.target.item.style = {
            strokeColor: gcolor,
            strokeWidth: 2,
            dashArray: [10,10]
          };
          this.target.item.fullySelected = false;
          this.target.stud.remove();
                  view.draw();
        }

        function spyrule(item){
          var spath = this.target.stud ? this.target.stud : this.target.item.clone();
          if (this.spiral.stopper > this.spiral.reps ){end.apply(this);return}
          ++this.spiral.stopper;
          
          var p = spath.segments[0].point
          ,   q = _.last(spath.segments).point
          ,   j = p
          ,   g = q
          ,   qp = q.subtract(j);

          if(spath.closed){
            g = q = p;
            this.target.center = p;
          }

          for (i = 1; i < spath.segments.length - 1; ++i){
            var ty = spath.segments[i].point.subtract(j), ti = spath.segments[i].point.add(j);
            ty.angle += this.spiral.angle;
            ty.length *= this.spiral.mx;
            spath.segments[i].point = g.add(ty);
            spath.segments[i].handleIn.angle += this.spiral.angle;
            spath.segments[i].handleOut.angle += this.spiral.angle;
            spath.segments[i].handleIn.length *= this.spiral.mx;
            spath.segments[i].handleOut.length *= this.spiral.mx;
          }
          
          spath.segments[0].point = q;
          spath.segments[0].handleIn.angle += this.spiral.angle;
          spath.segments[0].handleOut.angle += this.spiral.angle;
          spath.segments[0].handleIn.length *= this.spiral.mx;
          spath.segments[0].handleOut.length *= this.spiral.mx;
          qp.angle += this.spiral.angle;
            qp.length *= this.spiral.mx;
          _.last(spath.segments).point = q.add(qp);
          _.last(spath.segments).handleIn.angle += this.spiral.angle;
          _.last(spath.segments).handleOut.angle += this.spiral.angle;
          _.last(spath.segments).handleIn.length *= this.spiral.mx;
          _.last(spath.segments).handleOut.length *= this.spiral.mx;
          this.target.item.addSegments(spath.segments);
          this.target.stud = spath;
          window.setTimeout(spyrule.apply(this),12)
        
        } spyrule.apply(this)
    }}
  }
  gg.init();
};
function update(x){
  gg.spiral.angle = parseFloat(document.getElementById('angle').value);
  gg.spiral.mx = parseFloat(document.getElementById('mx').value);
  gg.spiral.reps = parseFloat(document.getElementById('reps').value);
  gg.spiral.go.apply(gg, [x])
}

	</script>
  <style>
  body, canvas, .canvas{
    background:#999;
    cursor: crosshair;
  }
  #box{
    z-index:3;
    background:red;
    height:76px;
    width:300px;
    display:none;
    position:absolute;
    top:10px;
  }
  #controls{
    width:100%;
    height:40px;
    position:fixed;
    bottom:0;
    left:0;
    background:#c1c2c3;
    z-index:1000;
    text-align:center;
  }
  #tools a{
    font-size:20px;
    margin: 0 30px
  }
  </style>

</head>
<body>
	<canvas id="canvas" resize style="background:white"></canvas>
  <div id="box"></div>
  <div id="controls">

      Angle: <input type="text" id="angle" value="60"></input>
      Growth Multiplier (1 = 100% = no growth): <input type="text" id="mx" value="1.009"></input>
      Reps: <input type="text" id="reps" value="120"></input>
      <input type="submit" value="Draw Spiral" onclick="javascript:update(evt)"></input>

  </div>
</body>
	<script type="text/javascript">
var dropzone = document.getElementById('tools');
dropzone.ondragover = function () { this.className = 'hover'; return false; };
dropzone.ondragend = function () { this.className = ''; return false; };
dropzone.ondrop = function (e){
    ees = e;
    files = e.dataTransfer.files,
    file = files[0];
    reader = new FileReader();        
    reader.onload = function (event) {
      even = event;
      console.log(event.target.result);
      var img = document.createElement('img');
      img.src=event.target.result;
      img.id = 'raster';
      img.style.zIndex = 9000;
      var cvas = document. getElementById('canvas');
      document.body.insertBefore(img, cvas );
      var raster = new Raster('raster')
      view.draw()
    };
    reader.readAsDataURL(files[0])
    //console.log(t.result);
    return false;
};
	</script>
<script type="text/javascript">
if ('standalone' in navigator && !navigator.standalone && (/iphone|ipod|ipad/gi).test(navigator.platform) && (/Safari/i).test(navigator.appVersion)) {
	document.write('<link rel="stylesheet" href="../stylesheets/add2home.css">');
	document.write('<script type="application/javascript" src="../javascripts/add2home.js"><\/s' + 'cript>');
}
</script>
</html>
